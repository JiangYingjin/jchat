# 系统消息数据恢复说明

## 问题描述

由于系统消息存储格式的更新，部分用户的系统提示词可能显示为错误信息：

```json
{
  "error": true,
  "message": "empty response"
}
```

**新增问题**：如果遇到 `QuotaExceededError` 错误，说明 localStorage 存储空间不足。

## 解决方案

### 方案一：使用 IndexedDB 存储（推荐）

新版本已经将系统消息存储迁移到 IndexedDB，提供更大的存储空间和更好的性能。

**自动迁移**：

- 应用启动时会自动将 localStorage 中的系统消息迁移到 IndexedDB
- 迁移过程中会验证数据完整性
- 迁移成功后会自动清理 localStorage 中的旧数据

**手动迁移**（如果需要）：

1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签页
3. 复制并粘贴以下代码：

```javascript
// 手动迁移到 IndexedDB
console.log("开始手动迁移系统消息到 IndexedDB...");

// 检查 IndexedDB 是否可用
if (!window.indexedDB) {
  console.error("浏览器不支持 IndexedDB");
  return;
}

// 创建 IndexedDB 数据库
const dbName = "SystemMessages";
const version = 1;
const storeName = "systemMessages";

const request = indexedDB.open(dbName, version);

request.onerror = () => {
  console.error("打开 IndexedDB 失败:", request.error);
};

request.onsuccess = () => {
  const db = request.result;
  console.log("IndexedDB 连接成功");

  // 开始迁移
  const systemKeys = [];
  for (let key in localStorage) {
    if (
      localStorage.hasOwnProperty(key) &&
      key.startsWith("system_message_content_")
    ) {
      systemKeys.push(key);
    }
  }

  if (systemKeys.length === 0) {
    console.log("没有找到需要迁移的系统消息");
    return;
  }

  console.log(`找到 ${systemKeys.length} 个系统消息需要迁移`);

  let successCount = 0;
  let errorCount = 0;

  systemKeys.forEach((key, index) => {
    const content = localStorage.getItem(key);
    if (content && content.trim() !== "") {
      const sessionId = key.replace("system_message_content_", "");

      const transaction = db.transaction([storeName], "readwrite");
      const store = transaction.objectStore(storeName);

      const data = {
        key: key,
        sessionId: sessionId,
        content: content,
        timestamp: Date.now(),
      };

      const putRequest = store.put(data);

      putRequest.onsuccess = () => {
        successCount++;
        // 迁移成功后删除 localStorage 中的数据
        localStorage.removeItem(key);
        localStorage.removeItem(key + "_time");
        console.log(`成功迁移: ${sessionId}`);

        if (successCount + errorCount === systemKeys.length) {
          console.log(
            `迁移完成: 成功 ${successCount} 个，失败 ${errorCount} 个`,
          );
        }
      };

      putRequest.onerror = () => {
        errorCount++;
        console.error(`迁移失败: ${sessionId}`, putRequest.error);

        if (successCount + errorCount === systemKeys.length) {
          console.log(
            `迁移完成: 成功 ${successCount} 个，失败 ${errorCount} 个`,
          );
        }
      };
    }
  });
};

request.onupgradeneeded = (event) => {
  const db = event.target.result;
  if (!db.objectStoreNames.contains(storeName)) {
    const store = db.createObjectStore(storeName, { keyPath: "key" });
    store.createIndex("sessionId", "sessionId", { unique: false });
    store.createIndex("timestamp", "timestamp", { unique: false });
    console.log("创建 IndexedDB 存储结构");
  }
};
```

4. 按回车执行脚本
5. 刷新页面查看迁移结果

### 方案二：修复现有数据

如果系统消息显示为错误格式，可以使用以下脚本修复：

1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签页
3. 复制并粘贴以下代码：

```javascript
// 修复系统消息脚本
console.log("开始修复系统消息...");

const chatData = localStorage.getItem("chat-next-web-store");
if (!chatData) {
  console.error("未找到聊天数据");
  return;
}

try {
  const chatStore = JSON.parse(chatData);
  let fixedCount = 0;
  let totalSessions = 0;

  if (chatStore.sessions && Array.isArray(chatStore.sessions)) {
    totalSessions = chatStore.sessions.length;

    chatStore.sessions.forEach((session, sessionIndex) => {
      if (session.messages && Array.isArray(session.messages)) {
        session.messages.forEach((message, messageIndex) => {
          if (message.role === "system") {
            // 检查是否是错误格式的系统消息
            if (
              message.isError &&
              message.content &&
              typeof message.content === "string"
            ) {
              try {
                const errorContent = JSON.parse(message.content);
                if (
                  errorContent.error &&
                  errorContent.message === "empty response"
                ) {
                  console.log(
                    `发现错误格式的系统消息，会话 ${sessionIndex + 1}`,
                  );

                  // 尝试从 IndexedDB 恢复
                  if (window.indexedDB) {
                    const dbName = "SystemMessages";
                    const storeName = "systemMessages";

                    const request = indexedDB.open(dbName, 1);
                    request.onsuccess = () => {
                      const db = request.result;
                      const transaction = db.transaction(
                        [storeName],
                        "readonly",
                      );
                      const store = transaction.objectStore(storeName);
                      const key = `system_message_content_${session.id}`;

                      const getRequest = store.get(key);
                      getRequest.onsuccess = () => {
                        const result = getRequest.result;
                        if (result && result.content) {
                          // 恢复成功
                          message.content = result.content;
                          message.isError = false;
                          fixedCount++;
                          console.log(
                            `已恢复系统消息内容: ${result.content.substring(0, 50)}...`,
                          );
                        } else {
                          // 恢复失败，删除该系统消息
                          session.messages.splice(messageIndex, 1);
                          fixedCount++;
                          console.log("未找到原始内容，删除该系统消息");
                        }

                        // 保存修复后的数据
                        localStorage.setItem(
                          "chat-next-web-store",
                          JSON.stringify(chatStore),
                        );
                        console.log(
                          `修复完成！共处理 ${totalSessions} 个会话，修复了 ${fixedCount} 个系统消息问题`,
                        );
                      };
                    };
                  } else {
                    // IndexedDB 不可用，尝试从 localStorage 恢复
                    const contentKey = `system_message_content_${session.id}`;
                    const originalContent = localStorage.getItem(contentKey);

                    if (originalContent) {
                      message.content = originalContent;
                      message.isError = false;
                      fixedCount++;
                      console.log(
                        `已恢复系统消息内容: ${originalContent.substring(0, 50)}...`,
                      );
                    } else {
                      session.messages.splice(messageIndex, 1);
                      fixedCount++;
                      console.log("未找到原始内容，删除该系统消息");
                    }
                  }
                }
              } catch (e) {
                // 跳过非错误格式的消息
              }
            }
          }
        });
      }
    });
  }

  // 保存修复后的数据
  localStorage.setItem("chat-next-web-store", JSON.stringify(chatStore));
  console.log(
    `修复完成！共处理 ${totalSessions} 个会话，修复了 ${fixedCount} 个系统消息问题`,
  );
  console.log("请刷新页面查看修复结果");
} catch (error) {
  console.error("修复过程中出现错误:", error);
}
```

4. 按回车执行脚本
5. 刷新页面查看修复结果

### 方案三：恢复备份数据

如果您有备份数据，可以使用以下脚本恢复：

1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签页
3. 复制并粘贴以下代码：

```javascript
// 恢复备份脚本
console.log("开始恢复备份数据...");

const backupData = prompt("请粘贴您的备份数据（JSON格式）:");

if (!backupData) {
  console.error("未提供备份数据");
  return;
}

try {
  const backup = JSON.parse(backupData);

  if (!backup.sessions || !Array.isArray(backup.sessions)) {
    console.error("备份数据格式不正确");
    return;
  }

  const currentData = localStorage.getItem("chat-next-web-store");
  if (currentData) {
    localStorage.setItem(
      "chat-next-web-store-backup-" + Date.now(),
      currentData,
    );
    console.log("已备份当前数据");
  }

  localStorage.setItem("chat-next-web-store", backupData);

  console.log(`恢复完成！共恢复 ${backup.sessions.length} 个会话`);
  console.log("请刷新页面查看恢复结果");
} catch (error) {
  console.error("恢复过程中出现错误:", error);
}
```

4. 按回车执行脚本
5. 在弹出的对话框中粘贴您的备份数据
6. 刷新页面查看恢复结果

### 方案四：手动恢复

如果您知道具体的系统提示词内容，可以：

1. 打开浏览器开发者工具（F12）
2. 切换到 Application 标签页
3. 在左侧找到 IndexedDB > SystemMessages > systemMessages
4. 找到对应的系统消息存储键（格式：`system_message_content_会话ID`）
5. 手动编辑或删除这些键值对

## 预防措施

为了避免类似问题，建议：

1. **使用 IndexedDB 存储**：新版本已自动迁移到 IndexedDB，提供更大的存储空间
2. **定期备份数据**：在更新前先备份重要数据
3. **监控存储使用**：定期检查 IndexedDB 使用情况
4. **避免过长的提示词**：虽然 IndexedDB 容量很大，但过长的提示词可能影响性能

## 技术说明

### IndexedDB 存储方案

- **优势**：容量大（通常几百MB到几GB），支持复杂数据结构，异步操作
- **迁移策略**：自动迁移 localStorage 数据到 IndexedDB，保留所有历史数据
- **数据验证**：迁移后自动验证数据完整性
- **错误恢复**：提供多种错误恢复机制

### 存储空间问题

- **原因**：localStorage 通常限制为 5-10MB
- **解决方案**：迁移到 IndexedDB，容量大幅提升
- **预防**：自动迁移和验证机制

### 数据迁移问题

- **原因**：系统消息存储格式的迁移过程中，部分数据没有正确迁移
- **解决方案**：完善的迁移逻辑，考虑多种情况
- **预防**：改进迁移流程，添加数据验证和错误恢复

如果您仍然遇到问题，请提供以下信息：

1. 浏览器版本
2. 应用版本
3. 具体的错误信息
4. 备份数据（如果可用）
5. IndexedDB 使用情况
6. 控制台错误日志
